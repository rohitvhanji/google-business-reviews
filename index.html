<!DOCTYPE html>
<html>
<head>
  <title>Fetch Google Business Reviews</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    const CLIENT_ID = '689299467388-j3qc9vn4j3m5hmje3u6s56qf2534e7bq.apps.googleusercontent.com'; // replace with your OAuth client ID
    const SCOPES = 'https://www.googleapis.com/auth/business.manage';

    let tokenClient;
    let accessToken = null;

    function handleAuthClick() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (response) => {
          if (response.access_token) {
            accessToken = response.access_token;
            document.getElementById("status").textContent = "Authenticated!";
            fetchLocations();
          }
        },
      });
      tokenClient.requestAccessToken();
    }

    async function fetchLocations() {
      const accountsRes = await fetch('https://mybusinessbusinessinformation.googleapis.com/v1/accounts', {
        headers: { Authorization: `Bearer ${accessToken}` },
      });
      const accounts = await accountsRes.json();
      const account = accounts.accounts?.[0];
      if (!account) {
        alert("No account found.");
        return;
      }

      const locationsRes = await fetch(
        `https://mybusinessbusinessinformation.googleapis.com/v1/${account.name}/locations`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const locations = await locationsRes.json();
      const location = locations.locations?.[0];
      if (!location) {
        alert("No location found.");
        return;
      }

      fetchReviews(location.name);
    }

    async function fetchReviews(locationName) {
      const reviewsRes = await fetch(
        `https://mybusiness.googleapis.com/v4/${locationName}/reviews`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await reviewsRes.json();
      const reviews = data.reviews || [];

      const output = document.getElementById("output");
      output.innerHTML = `<h2>Reviews:</h2>`;
      reviews.forEach((r, i) => {
        output.innerHTML += `
          <div style="margin-bottom: 1em; padding: 1em; border: 1px solid #ccc;">
            <strong>${r.reviewer?.displayName || 'Anonymous'}</strong> 
            rated <b>${r.starRating}</b><br>
            <em>${new Date(r.createTime).toLocaleString()}</em><br>
            <p>${r.comment}</p>
          </div>`;
      });
    }
  </script>
</head>
<body>
  <h1>Google Business Reviews Viewer</h1>
  <button onclick="handleAuthClick()">Login with Google</button>
  <p id="status">Not authenticated.</p>
  <div id="output"></div>
</body>
</html>
